<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Benchmark Dashboard</title>

    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 0;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header h1 .icon {
            font-size: 28px;
        }

        .breadcrumb {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Main Page Styles */
        .difficulty-section {
            margin-bottom: 40px;
        }

        .difficulty-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .difficulty-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .difficulty-badge.easy { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .difficulty-badge.medium { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .difficulty-badge.hard { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .task-table th,
        .task-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .task-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .task-table tr:last-child td {
            border-bottom: none;
        }

        .task-table tr:hover {
            background: var(--bg-tertiary);
        }

        .task-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .run-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .run-link.pass {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(63, 185, 80, 0.3);
        }

        .run-link.pass:hover {
            background: rgba(63, 185, 80, 0.25);
        }

        .run-link.fail {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .run-link.fail:hover {
            background: rgba(248, 81, 73, 0.25);
        }

        .run-link.pending {
            background: rgba(139, 148, 158, 0.15);
            color: var(--text-secondary);
            border: 1px solid rgba(139, 148, 158, 0.3);
        }

        /* Detail Page Styles */
        .detail-page {
            display: none;
        }

        .detail-page.active {
            display: block;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--text-secondary);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .metric-card .label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .metric-card .value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-card .value.success { color: var(--accent-green); }
        .metric-card .value.fail { color: var(--accent-red); }

        .metric-card .subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .tool-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .tool-card .name {
            font-size: 14px;
            font-weight: 500;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }

        .tool-card .count {
            font-size: 24px;
            font-weight: 600;
        }

        .tool-card .errors {
            font-size: 12px;
            color: var(--accent-red);
            margin-top: 4px;
        }

        /* LLM Judge Markdown Styles */
        .llm-judge-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
        }

        .llm-judge-content h1,
        .llm-judge-content h2,
        .llm-judge-content h3 {
            color: var(--text-primary);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .llm-judge-content h1 { font-size: 24px; }
        .llm-judge-content h2 { font-size: 20px; }
        .llm-judge-content h3 { font-size: 16px; }

        .llm-judge-content p {
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .llm-judge-content strong {
            color: var(--text-primary);
        }

        .llm-judge-content ul,
        .llm-judge-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .llm-judge-content li {
            margin-bottom: 6px;
        }

        .llm-judge-content code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
        }

        .llm-judge-content pre {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        .llm-judge-content pre code {
            background: none;
            padding: 0;
        }

        .llm-judge-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
        }

        .llm-judge-content blockquote {
            border-left: 3px solid var(--accent-blue);
            padding-left: 16px;
            margin: 12px 0;
            color: var(--text-secondary);
        }

        /* Summary Stats */
        .summary-bar {
            display: flex;
            gap: 20px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .summary-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-stat .label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .summary-stat .value {
            font-weight: 600;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Tabs for charts */
        .chart-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .chart-tab {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .chart-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .chart-tab:hover:not(.active) {
            background: var(--bg-secondary);
        }

        /* Comparison Page Styles */
        .compare-page {
            display: none;
        }

        .compare-page.active {
            display: block;
        }

        .compare-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            background: rgba(163, 113, 247, 0.15);
            color: var(--accent-purple);
            border: 1px solid rgba(163, 113, 247, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .compare-btn:hover {
            background: rgba(163, 113, 247, 0.25);
        }

        .compare-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .compare-header h2 {
            font-size: 24px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .comparison-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .comparison-table th:first-child {
            width: 200px;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table .metric-name {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .comparison-table .value {
            font-weight: 600;
            font-size: 16px;
        }

        .comparison-table .better {
            color: var(--accent-green);
        }

        .comparison-table .worse {
            color: var(--accent-red);
        }

        .comparison-table .delta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .comparison-table .delta.positive {
            color: var(--accent-green);
        }

        .comparison-table .delta.negative {
            color: var(--accent-red);
        }

        .run-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .run-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .run-status-dot.pass {
            background: var(--accent-green);
        }

        .run-status-dot.fail {
            background: var(--accent-red);
        }

        .llm-judge-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .llm-judge-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .llm-judge-panel-header {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .llm-judge-panel-content {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .tools-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .tools-comparison-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .tools-comparison-panel h4 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .summary-bar {
                flex-wrap: wrap;
            }

            .llm-judge-comparison {
                grid-template-columns: 1fr;
            }

            .tools-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><span class="icon">üìä</span> Agent Benchmark Dashboard</h1>
            <div class="breadcrumb" id="breadcrumb">
                <span>Overview</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Main Page -->
        <div id="main-page" class="main-page">
            <div class="summary-bar" id="summary-bar">
                <div class="summary-stat">
                    <span class="label">Total Tasks:</span>
                    <span class="value" id="total-tasks">-</span>
                </div>
                <div class="summary-stat">
                    <span class="label">Pass Rate:</span>
                    <span class="value" id="pass-rate">-</span>
                </div>
                <div class="summary-stat">
                    <span class="label">Total Cost:</span>
                    <span class="value" id="total-cost">-</span>
                </div>
            </div>

            <div id="tasks-container">
                <div class="loading">Loading benchmark data...</div>
            </div>
        </div>

        <!-- Detail Page -->
        <div id="detail-page" class="detail-page">
            <button class="back-btn" onclick="showMainPage()">
                <span>‚Üê</span> Back to Overview
            </button>

            <div id="detail-header">
                <!-- Filled by JS -->
            </div>

            <h3 class="section-title">Key Metrics</h3>
            <div class="metrics-grid" id="metrics-grid">
                <!-- Filled by JS -->
            </div>

            <h3 class="section-title">Context & Cache Analysis</h3>
            <div class="chart-container">
                <div class="chart-tabs">
                    <button class="chart-tab active" onclick="switchChart('context')">Context Growth</button>
                    <button class="chart-tab" onclick="switchChart('cache')">Cache Hit Rate</button>
                    <button class="chart-tab" onclick="switchChart('tokens')">Tokens per Turn</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="main-chart"></canvas>
                </div>
            </div>

            <h3 class="section-title">Tool Usage</h3>
            <div class="tools-grid" id="tools-grid">
                <!-- Filled by JS -->
            </div>

            <h3 class="section-title">LLM Judge Analysis</h3>
            <div class="llm-judge-content" id="llm-judge-content">
                <div class="loading">Loading analysis...</div>
            </div>
        </div>

        <!-- Comparison Page -->
        <div id="compare-page" class="compare-page">
            <button class="back-btn" onclick="showMainPage()">
                <span>‚Üê</span> Back to Overview
            </button>

            <div id="compare-header" class="compare-header">
                <!-- Filled by JS -->
            </div>

            <h3 class="section-title">Metrics Comparison</h3>
            <table class="comparison-table" id="comparison-table">
                <!-- Filled by JS -->
            </table>

            <h3 class="section-title">Context Growth Comparison</h3>
            <div class="chart-container">
                <div class="chart-tabs" id="compare-chart-tabs">
                    <button class="chart-tab active" onclick="switchCompareChart('context')">Context Growth</button>
                    <button class="chart-tab" onclick="switchCompareChart('cache')">Cache Hit Rate</button>
                    <button class="chart-tab" onclick="switchCompareChart('output')">Output Tokens</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="compare-chart"></canvas>
                </div>
            </div>

            <h3 class="section-title">Tool Usage Comparison</h3>
            <div class="tools-comparison" id="tools-comparison">
                <!-- Filled by JS -->
            </div>

            <h3 class="section-title">LLM Judge Analysis Comparison</h3>
            <div class="llm-judge-comparison" id="llm-judge-comparison">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <script>
        // Global state
        let benchmarkData = {};
        let currentChart = null;
        let currentQuantData = null;
        let compareChart = null;
        let currentCompareData = null;

        // Data loading
        async function loadBenchmarkData() {
            const difficulties = ['easy', 'medium', 'hard'];
            const data = {};

            for (const difficulty of difficulties) {
                data[difficulty] = {};

                try {
                    // Try to list tasks in this difficulty
                    const tasks = await discoverTasks(difficulty);

                    for (const taskName of tasks) {
                        data[difficulty][taskName] = {
                            run_1: await loadRunData(difficulty, taskName, 'run_1'),
                            run_2: await loadRunData(difficulty, taskName, 'run_2')
                        };
                    }
                } catch (e) {
                    console.log(`No tasks found for ${difficulty}`);
                }
            }

            return data;
        }

        async function discoverTasks(difficulty) {
            // We'll try to fetch a known structure
            // Since we can't list directories in browser, we'll try common patterns
            const tasks = [];
            const knownTasks = [
                'fix-git', 'cobol-modernization', 'overfull-hbox', 'prove-plus-comm',
                'bayesian-network', 'debug-memory', 'optimize-sql', 'refactor-legacy',
                'implement-cache', 'fix-race-condition', 'parse-binary', 'fix-regex'
            ];

            for (const task of knownTasks) {
                try {
                    const response = await fetch(`data/${difficulty}/${task}/run_1/reward.txt`);
                    if (response.ok) {
                        tasks.push(task);
                    }
                } catch (e) {
                    // Task doesn't exist
                }
            }

            return tasks;
        }

        async function loadRunData(difficulty, taskName, runName) {
            const basePath = `data/${difficulty}/${taskName}/${runName}`;

            try {
                const [rewardRes, quantRes, judgeRes] = await Promise.all([
                    fetch(`${basePath}/reward.txt`).catch(() => null),
                    fetch(`${basePath}/analysis-quantitative.json`).catch(() => null),
                    fetch(`${basePath}/analysis-llm-judge.md`).catch(() => null)
                ]);

                const reward = rewardRes?.ok ? (await rewardRes.text()).trim() : null;
                const quant = quantRes?.ok ? await quantRes.json() : null;
                const judge = judgeRes?.ok ? await judgeRes.text() : null;

                return {
                    exists: reward !== null,
                    passed: reward === '1',
                    quantitative: quant,
                    llmJudge: judge
                };
            } catch (e) {
                return { exists: false, passed: false, quantitative: null, llmJudge: null };
            }
        }

        // Rendering
        function renderMainPage() {
            const container = document.getElementById('tasks-container');
            let html = '';
            let totalTasks = 0;
            let totalPassed = 0;
            let totalCost = 0;

            const difficulties = ['easy', 'medium', 'hard'];

            for (const difficulty of difficulties) {
                const tasks = benchmarkData[difficulty];
                const taskNames = Object.keys(tasks);

                if (taskNames.length === 0) continue;

                html += `
                    <div class="difficulty-section">
                        <div class="difficulty-header">
                            <h2>${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}</h2>
                            <span class="difficulty-badge ${difficulty}">${taskNames.length} tasks</span>
                        </div>
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th>Task Name</th>
                                    <th>Run 1</th>
                                    <th>Run 2</th>
                                    <th>Compare</th>
                                    <th>Avg Cost</th>
                                    <th>Avg Turns</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const taskName of taskNames) {
                    const task = tasks[taskName];
                    totalTasks++;

                    const run1Class = task.run_1.exists ? (task.run_1.passed ? 'pass' : 'fail') : 'pending';
                    const run2Class = task.run_2.exists ? (task.run_2.passed ? 'pass' : 'fail') : 'pending';

                    const run1Label = task.run_1.exists ? (task.run_1.passed ? '‚úì Pass' : '‚úó Fail') : '‚Äî';
                    const run2Label = task.run_2.exists ? (task.run_2.passed ? '‚úì Pass' : '‚úó Fail') : '‚Äî';

                    if (task.run_1.passed) totalPassed++;
                    if (task.run_2.passed) totalPassed++;

                    // Calculate averages
                    let avgCost = 0;
                    let avgTurns = 0;
                    let count = 0;

                    if (task.run_1.quantitative) {
                        avgCost += task.run_1.quantitative.cost.totalCost;
                        avgTurns += task.run_1.quantitative.turns.totalTurns;
                        totalCost += task.run_1.quantitative.cost.totalCost;
                        count++;
                    }
                    if (task.run_2.quantitative) {
                        avgCost += task.run_2.quantitative.cost.totalCost;
                        avgTurns += task.run_2.quantitative.turns.totalTurns;
                        totalCost += task.run_2.quantitative.cost.totalCost;
                        count++;
                    }

                    avgCost = count > 0 ? (avgCost / count) : 0;
                    avgTurns = count > 0 ? Math.round(avgTurns / count) : 0;

                    const canCompare = task.run_1.exists && task.run_2.exists &&
                                      task.run_1.quantitative && task.run_2.quantitative;

                    html += `
                        <tr>
                            <td class="task-name">${taskName}</td>
                            <td>
                                <span class="run-link ${run1Class}"
                                      onclick="showDetailPage('${difficulty}', '${taskName}', 'run_1')"
                                      ${!task.run_1.exists ? 'style="pointer-events:none"' : ''}>
                                    ${run1Label}
                                </span>
                            </td>
                            <td>
                                <span class="run-link ${run2Class}"
                                      onclick="showDetailPage('${difficulty}', '${taskName}', 'run_2')"
                                      ${!task.run_2.exists ? 'style="pointer-events:none"' : ''}>
                                    ${run2Label}
                                </span>
                            </td>
                            <td>
                                ${canCompare ? `
                                    <button class="compare-btn" onclick="showComparePage('${difficulty}', '${taskName}')">
                                        ‚áÑ Compare
                                    </button>
                                ` : '<span style="color: var(--text-secondary)">‚Äî</span>'}
                            </td>
                            <td>$${avgCost.toFixed(4)}</td>
                            <td>${avgTurns}</td>
                        </tr>
                    `;
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            if (html === '') {
                html = `
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>No benchmark data found.</p>
                        <p>Make sure to run benchmarks and place results in the data/ folder.</p>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Update summary
            const totalRuns = totalTasks * 2;
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('pass-rate').textContent = totalRuns > 0 ?
                `${Math.round((totalPassed / totalRuns) * 100)}%` : '-';
            document.getElementById('total-cost').textContent = `$${totalCost.toFixed(4)}`;
        }

        function showDetailPage(difficulty, taskName, runName) {
            const task = benchmarkData[difficulty][taskName];
            const run = task[runName];

            if (!run.exists) return;

            document.getElementById('main-page').style.display = 'none';
            document.getElementById('detail-page').classList.add('active');

            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#" onclick="showMainPage(); return false;">Overview</a>
                <span> / </span>
                <span>${difficulty}</span>
                <span> / </span>
                <span>${taskName}</span>
                <span> / </span>
                <span>${runName}</span>
            `;

            // Render header
            const statusClass = run.passed ? 'success' : 'fail';
            const statusText = run.passed ? 'PASSED' : 'FAILED';
            document.getElementById('detail-header').innerHTML = `
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <h2 style="font-size: 24px;">${taskName}</h2>
                    <span class="difficulty-badge ${difficulty}">${difficulty}</span>
                    <span class="run-link ${run.passed ? 'pass' : 'fail'}">${statusText}</span>
                </div>
            `;

            // Render metrics
            currentQuantData = run.quantitative;
            if (currentQuantData) {
                renderMetrics(currentQuantData);
                renderToolsGrid(currentQuantData);
                renderChart('context');
            }

            // Render LLM Judge
            if (run.llmJudge) {
                document.getElementById('llm-judge-content').innerHTML = marked.parse(run.llmJudge);
            } else {
                document.getElementById('llm-judge-content').innerHTML = '<p>No LLM judge analysis available.</p>';
            }
        }

        function showMainPage() {
            document.getElementById('main-page').style.display = 'block';
            document.getElementById('detail-page').classList.remove('active');
            document.getElementById('compare-page').classList.remove('active');
            document.getElementById('breadcrumb').innerHTML = '<span>Overview</span>';

            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            if (compareChart) {
                compareChart.destroy();
                compareChart = null;
            }
        }

        function showComparePage(difficulty, taskName) {
            const task = benchmarkData[difficulty][taskName];

            if (!task.run_1.exists || !task.run_2.exists) return;

            document.getElementById('main-page').style.display = 'none';
            document.getElementById('detail-page').classList.remove('active');
            document.getElementById('compare-page').classList.add('active');

            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#" onclick="showMainPage(); return false;">Overview</a>
                <span> / </span>
                <span>${difficulty}</span>
                <span> / </span>
                <span>${taskName}</span>
                <span> / </span>
                <span>Compare Runs</span>
            `;

            // Store comparison data
            currentCompareData = {
                difficulty,
                taskName,
                run_1: task.run_1,
                run_2: task.run_2
            };

            // Render header
            document.getElementById('compare-header').innerHTML = `
                <h2>${taskName}</h2>
                <span class="difficulty-badge ${difficulty}">${difficulty}</span>
                <span style="color: var(--text-secondary);">Run 1 vs Run 2</span>
            `;

            // Render comparison table
            renderComparisonTable(task.run_1, task.run_2);

            // Render comparison chart
            renderCompareChart('context');

            // Render tools comparison
            renderToolsComparison(task.run_1, task.run_2);

            // Render LLM judge comparison
            renderLLMJudgeComparison(task.run_1, task.run_2);
        }

        function renderComparisonTable(run1, run2) {
            const q1 = run1.quantitative;
            const q2 = run2.quantitative;

            if (!q1 || !q2) return;

            // Helper to calculate delta and determine if lower is better
            const getDelta = (v1, v2, lowerIsBetter = true) => {
                const delta = v2 - v1;
                const pct = v1 !== 0 ? ((delta / v1) * 100).toFixed(1) : 0;
                const isImproved = lowerIsBetter ? delta < 0 : delta > 0;
                return { delta, pct, isImproved };
            };

            const metrics = [
                { name: 'Status', v1: run1.passed ? 'PASSED' : 'FAILED', v2: run2.passed ? 'PASSED' : 'FAILED', isStatus: true },
                { name: 'Total Cost', v1: q1.cost.totalCost, v2: q2.cost.totalCost, format: v => `$${v.toFixed(4)}`, lowerBetter: true },
                { name: 'Total Turns', v1: q1.turns.totalTurns, v2: q2.turns.totalTurns, format: v => v, lowerBetter: true },
                { name: 'Tool Calls', v1: q1.tools.totalToolCalls, v2: q2.tools.totalToolCalls, format: v => v, lowerBetter: true },
                { name: 'Peak Context', v1: q1.context.peakContext, v2: q2.context.peakContext, format: v => formatNumber(v), lowerBetter: true },
                { name: 'Final Context', v1: q1.context.finalContext, v2: q2.context.finalContext, format: v => formatNumber(v), lowerBetter: true },
                { name: 'Context Growth', v1: q1.cost.contextGrowth, v2: q2.cost.contextGrowth, format: v => formatNumber(v), lowerBetter: true },
                { name: 'Cache Hit Rate', v1: q1.context.cacheHitRate * 100, v2: q2.context.cacheHitRate * 100, format: v => `${v.toFixed(1)}%`, lowerBetter: false },
                { name: 'Error Rate', v1: q1.tools.errorRate * 100, v2: q2.tools.errorRate * 100, format: v => `${v.toFixed(1)}%`, lowerBetter: true },
                { name: 'Total Errors', v1: q1.errors.totalErrors, v2: q2.errors.totalErrors, format: v => v, lowerBetter: true },
                { name: 'Input Tokens', v1: q1.cost.cumulativeInputTokens, v2: q2.cost.cumulativeInputTokens, format: v => formatNumber(v), lowerBetter: true },
                { name: 'Output Tokens', v1: q1.cost.cumulativeOutputTokens, v2: q2.cost.cumulativeOutputTokens, format: v => formatNumber(v), lowerBetter: true },
            ];

            let html = `
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>
                            <div class="run-header">
                                <span class="run-status-dot ${run1.passed ? 'pass' : 'fail'}"></span>
                                Run 1
                            </div>
                        </th>
                        <th>
                            <div class="run-header">
                                <span class="run-status-dot ${run2.passed ? 'pass' : 'fail'}"></span>
                                Run 2
                            </div>
                        </th>
                        <th>Delta</th>
                    </tr>
                </thead>
                <tbody>
            `;

            for (const metric of metrics) {
                if (metric.isStatus) {
                    html += `
                        <tr>
                            <td class="metric-name">${metric.name}</td>
                            <td><span class="value ${run1.passed ? 'better' : 'worse'}">${metric.v1}</span></td>
                            <td><span class="value ${run2.passed ? 'better' : 'worse'}">${metric.v2}</span></td>
                            <td>‚Äî</td>
                        </tr>
                    `;
                } else {
                    const { delta, pct, isImproved } = getDelta(metric.v1, metric.v2, metric.lowerBetter);
                    const v1Formatted = metric.format(metric.v1);
                    const v2Formatted = metric.format(metric.v2);

                    const deltaSign = delta > 0 ? '+' : '';
                    const deltaClass = delta === 0 ? '' : (isImproved ? 'positive' : 'negative');

                    html += `
                        <tr>
                            <td class="metric-name">${metric.name}</td>
                            <td><span class="value">${v1Formatted}</span></td>
                            <td><span class="value">${v2Formatted}</span></td>
                            <td>
                                <span class="delta ${deltaClass}">
                                    ${deltaSign}${pct}%
                                </span>
                            </td>
                        </tr>
                    `;
                }
            }

            html += '</tbody>';
            document.getElementById('comparison-table').innerHTML = html;
        }

        function switchCompareChart(type) {
            document.querySelectorAll('#compare-chart-tabs .chart-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCompareChart(type);
        }

        function renderCompareChart(type) {
            if (!currentCompareData) return;

            const q1 = currentCompareData.run_1.quantitative;
            const q2 = currentCompareData.run_2.quantitative;

            if (!q1 || !q2) return;

            const ctx = document.getElementById('compare-chart').getContext('2d');

            if (compareChart) {
                compareChart.destroy();
            }

            // Use the longer run for labels
            const maxTurns = Math.max(
                q1.context.contextGrowthCurve.length,
                q2.context.contextGrowthCurve.length
            );
            const labels = Array.from({ length: maxTurns }, (_, i) => `Turn ${i + 1}`);

            let datasets = [];
            let yAxisLabel = '';

            if (type === 'context') {
                datasets = [
                    {
                        label: 'Run 1 Context',
                        data: q1.context.contextGrowthCurve,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'Run 2 Context',
                        data: q2.context.contextGrowthCurve,
                        borderColor: '#a371f7',
                        backgroundColor: 'rgba(163, 113, 247, 0.1)',
                        fill: false,
                        tension: 0.3
                    }
                ];
                yAxisLabel = 'Tokens';
            } else if (type === 'cache') {
                datasets = [
                    {
                        label: 'Run 1 Cache Hit Rate',
                        data: q1.context.cacheUtilizationCurve.map(v => v * 100),
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'Run 2 Cache Hit Rate',
                        data: q2.context.cacheUtilizationCurve.map(v => v * 100),
                        borderColor: '#a371f7',
                        backgroundColor: 'rgba(163, 113, 247, 0.1)',
                        fill: false,
                        tension: 0.3
                    }
                ];
                yAxisLabel = 'Hit Rate (%)';
            } else if (type === 'output') {
                datasets = [
                    {
                        label: 'Run 1 Output Tokens',
                        data: q1.turns.outputTokensPerTurn,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.5)',
                    },
                    {
                        label: 'Run 2 Output Tokens',
                        data: q2.turns.outputTokensPerTurn,
                        borderColor: '#a371f7',
                        backgroundColor: 'rgba(163, 113, 247, 0.5)',
                    }
                ];
                yAxisLabel = 'Tokens';
            }

            compareChart = new Chart(ctx, {
                type: type === 'output' ? 'bar' : 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#8b949e' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#8b949e'
                            },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
        }

        function renderToolsComparison(run1, run2) {
            const q1 = run1.quantitative;
            const q2 = run2.quantitative;

            if (!q1 || !q2) return;

            const container = document.getElementById('tools-comparison');

            // Get all unique tools
            const allTools = new Set([
                ...Object.keys(q1.tools.toolCounts),
                ...Object.keys(q2.tools.toolCounts)
            ]);

            const renderToolsPanel = (quant, runName, passed) => {
                const tools = Object.entries(quant.tools.toolCounts)
                    .sort((a, b) => b[1] - a[1]);

                return `
                    <div class="tools-comparison-panel">
                        <h4>
                            <span class="run-status-dot ${passed ? 'pass' : 'fail'}"></span>
                            ${runName}
                        </h4>
                        <div class="tools-grid" style="margin-bottom: 0;">
                            ${tools.map(([name, count]) => {
                                const errors = quant.tools.toolErrors[name] || 0;
                                return `
                                    <div class="tool-card">
                                        <div class="name">${name}</div>
                                        <div class="count">${count}</div>
                                        ${errors > 0 ? `<div class="errors">${errors} errors</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            };

            container.innerHTML = `
                ${renderToolsPanel(q1, 'Run 1', run1.passed)}
                ${renderToolsPanel(q2, 'Run 2', run2.passed)}
            `;
        }

        function renderLLMJudgeComparison(run1, run2) {
            const container = document.getElementById('llm-judge-comparison');

            const renderPanel = (run, runName) => {
                const content = run.llmJudge
                    ? marked.parse(run.llmJudge)
                    : '<p style="color: var(--text-secondary);">No LLM judge analysis available.</p>';

                return `
                    <div class="llm-judge-panel">
                        <div class="llm-judge-panel-header">
                            <span class="run-status-dot ${run.passed ? 'pass' : 'fail'}"></span>
                            ${runName}
                        </div>
                        <div class="llm-judge-panel-content llm-judge-content">
                            ${content}
                        </div>
                    </div>
                `;
            };

            container.innerHTML = `
                ${renderPanel(run1, 'Run 1')}
                ${renderPanel(run2, 'Run 2')}
            `;
        }

        function renderMetrics(data) {
            const metrics = [
                { label: 'Total Cost', value: `$${data.cost.totalCost.toFixed(4)}`, subtitle: `$${data.cost.avgCostPerTurn.toFixed(4)}/turn` },
                { label: 'Total Turns', value: data.turns.totalTurns, subtitle: `${data.tools.totalToolCalls} tool calls` },
                { label: 'Peak Context', value: formatNumber(data.context.peakContext), subtitle: 'tokens' },
                { label: 'Context Growth', value: formatNumber(data.cost.contextGrowth), subtitle: `${data.cost.initialContextTokens} ‚Üí ${data.cost.finalContextTokens}` },
                { label: 'Cache Hit Rate', value: `${(data.context.cacheHitRate * 100).toFixed(1)}%`, subtitle: 'of input tokens' },
                { label: 'Error Rate', value: `${(data.tools.errorRate * 100).toFixed(1)}%`, subtitle: `${data.errors.totalErrors} errors` },
                { label: 'Input Tokens', value: formatNumber(data.cost.cumulativeInputTokens), subtitle: 'total' },
                { label: 'Output Tokens', value: formatNumber(data.cost.cumulativeOutputTokens), subtitle: 'total' }
            ];

            const grid = document.getElementById('metrics-grid');
            grid.innerHTML = metrics.map(m => `
                <div class="metric-card">
                    <div class="label">${m.label}</div>
                    <div class="value">${m.value}</div>
                    <div class="subtitle">${m.subtitle}</div>
                </div>
            `).join('');
        }

        function renderToolsGrid(data) {
            const tools = Object.entries(data.tools.toolCounts)
                .sort((a, b) => b[1] - a[1]);

            const grid = document.getElementById('tools-grid');
            grid.innerHTML = tools.map(([name, count]) => {
                const errors = data.tools.toolErrors[name] || 0;
                return `
                    <div class="tool-card">
                        <div class="name">${name}</div>
                        <div class="count">${count}</div>
                        ${errors > 0 ? `<div class="errors">${errors} errors</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function switchChart(type) {
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(type)) {
                    tab.classList.add('active');
                }
            });
            renderChart(type);
        }

        function renderChart(type) {
            if (!currentQuantData) return;

            const ctx = document.getElementById('main-chart').getContext('2d');

            if (currentChart) {
                currentChart.destroy();
            }

            const labels = currentQuantData.context.contextGrowthCurve.map((_, i) => `Turn ${i + 1}`);

            let datasets = [];
            let yAxisLabel = '';

            if (type === 'context') {
                datasets = [{
                    label: 'Context Size (tokens)',
                    data: currentQuantData.context.contextGrowthCurve,
                    borderColor: '#58a6ff',
                    backgroundColor: 'rgba(88, 166, 255, 0.1)',
                    fill: true,
                    tension: 0.3
                }];
                yAxisLabel = 'Tokens';
            } else if (type === 'cache') {
                datasets = [{
                    label: 'Cache Hit Rate',
                    data: currentQuantData.context.cacheUtilizationCurve.map(v => v * 100),
                    borderColor: '#3fb950',
                    backgroundColor: 'rgba(63, 185, 80, 0.1)',
                    fill: true,
                    tension: 0.3
                }];
                yAxisLabel = 'Hit Rate (%)';
            } else if (type === 'tokens') {
                datasets = [
                    {
                        label: 'Input Tokens',
                        data: currentQuantData.turns.inputTokensPerTurn,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.5)',
                        type: 'bar'
                    },
                    {
                        label: 'Output Tokens',
                        data: currentQuantData.turns.outputTokensPerTurn,
                        borderColor: '#a371f7',
                        backgroundColor: 'rgba(163, 113, 247, 0.5)',
                        type: 'bar'
                    }
                ];
                yAxisLabel = 'Tokens';
            }

            currentChart = new Chart(ctx, {
                type: type === 'tokens' ? 'bar' : 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#8b949e' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#8b949e'
                            },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Initialize
        async function init() {
            try {
                benchmarkData = await loadBenchmarkData();
                renderMainPage();
            } catch (e) {
                console.error('Failed to load benchmark data:', e);
                document.getElementById('tasks-container').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <p>Failed to load benchmark data.</p>
                        <p>Make sure to serve this file from a local server:</p>
                        <code style="display: block; margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px;">
                            npx serve .
                        </code>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>
